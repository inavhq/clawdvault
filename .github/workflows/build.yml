name: Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: app/pnpm-lock.yaml

    - name: Install dependencies
      working-directory: ./app
      run: pnpm install --frozen-lockfile

    - name: Type check
      working-directory: ./app
      run: pnpm exec tsc --noEmit

    - name: Build Next.js app
      working-directory: ./app
      run: pnpm run build
      env:
        # Skip env validation for build test
        SKIP_ENV_VALIDATION: true
        # Dummy secrets for build (not used at build time, but API routes require them at module eval)
        JWT_SECRET: ci-build-dummy-secret-not-used-at-runtime
        ENCRYPTION_KEY: ci-build-dummy-key-not-used-at-runtime
        
    - name: Check for build errors
      working-directory: ./app
      run: |
        if [ ! -d ".next" ]; then
          echo "❌ Build failed - .next directory not found"
          exit 1
        fi
        echo "✅ Build successful"
    - name: Discord Notification
      if: failure()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_CI_WEBHOOK }}
        title: Build Failed — clawdvault
        noprefix: true
