name: Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: app/pnpm-lock.yaml

    - name: Install dependencies
      working-directory: ./app
      run: pnpm install --frozen-lockfile

    - name: Type check
      working-directory: ./app
      run: pnpm exec tsc --noEmit

    - name: Build Next.js app
      working-directory: ./app
      run: pnpm run build
      env:
        # Skip env validation for build test
        SKIP_ENV_VALIDATION: true
        # Dummy secrets for build (not used at build time, but API routes require them at module eval)
        JWT_SECRET: ci-build-dummy-secret-not-used-at-runtime
        ENCRYPTION_KEY: ci-build-dummy-key-not-used-at-runtime
        
    - name: Check for build errors
      working-directory: ./app
      run: |
        if [ ! -d ".next" ]; then
          echo "‚ùå Build failed - .next directory not found"
          exit 1
        fi
        echo "‚úÖ Build successful"
    - name: Telegram Notification
      if: failure()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": 198769209, \"text\": \"üö® CI Failed ‚Äî clawdvault\n\nBranch: ${GITHUB_HEAD_REF}\nPR: #${PR_NUMBER}\nRun: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"}"
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
